#!/usr/bin/env bash

set -euo pipefail

battery_percent() {
    case $(uname -s) in
    Linux)
        percent=$(linux_acpi percent)
        [ -n "$percent" ] && echo " $percent"
        ;;
    Darwin) echo $(pmset -g batt | grep -Eo '[0-9]?[0-9]?[0-9]%' | sed 's/%//g') ;;
    FreeBSD) echo $(apm | sed '8,11d' | grep life | awk '{print $4}') ;;
    esac
}

battery_status() {
    case $(uname -s) in
    Linux) status=$(linux_acpi status) ;;
    Darwin) status=$(pmset -g batt | sed -n 2p | cut -d ';' -f 2 | tr -d " ") ;;
    FreeBSD) status=$(apm | sed '8,11d' | grep Status | awk '{printf $3}') ;;
    esac
    case $status in
    discharging | Discharging | high) echo false;;
    ACattached | charging | Charging) echo true;;
    esac
}

first_le() {
  local target=$1
  local -n keys=$2
  local -n values=$3
  for i in "${!keys[@]}"; do
    if (( keys[i] <= target )); then
      echo "${values[i]}"
      return
    fi
  done
}

main() {
    bat_stat=$(battery_status)
    t="$(battery_percent)"

    local result=""
    while getopts ":sbfi" option; do
      case $option in
        s)
          result+="$t"
          ;;

        b)
          local k=(100 87 75 62 50 37 25 12)
          local v=(█ ▇ ▆ ▅ ▄ ▃ ▂ ▁)
          result+=$(first_le t k v)
          ;;

        f)
          local k=(100 87 83 80 66 62 60 40 37 33 20 16 12)
          local v=(1 ⅞ ⅚ ⅘ ⅔ ⅝ ⅗ ⅖ ⅜ ⅓ ⅕ ⅙ ⅛)
          result+=$(first_le t k v)
          ;;

        i)
          if $bat_stat; then
            local k=(100 90 80 70 60 50 40 30 20 10 0)
            local v=(󰂅 󰂋 󰂊 󰢞 󰂉 󰢝 󰂈 󰂇 󰂆 󰢜 󰢟) # '󱉞'
          else
            local k=(100 90 80 70 60 50 40 30 20 10 0)
            local v=(󰁹 󰂂 󰂁 󰂀 󰁿 󰁾 󰁽 󰁼 󰁻 󰁺 󰂎) # [false]='󱉞'
          fi
          result+=$(first_le t k v)
          ;;

        \?) # Invalid option
          echo "Error: Invalid option"
          exit;;
      esac
    done
    echo $result
  }

main "$@"
