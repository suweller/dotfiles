# vim:foldmethod=marker

if [[ $ZPROF != "" ]]; then
  zmodload zsh/zprof
fi

# Make the $path array have unique values.
typeset -U path
function add_to_path_once() {
  path=("$1" $path)
}

add_to_path_once "$HOME/.dotfiles/bin"
add_to_path_once "/opt/homebrew/bin"
add_to_path_once "/sbin"
add_to_path_once "/usr/local/bin"
add_to_path_once "/usr/local/sbin"
add_to_path_once "/usr/sbin"

# Export Variables {{{
export BLOCK_SIZE=human-readable # https://www.gnu.org/software/coreutils/manual/html_node/Block-size.html
export CLICOLOR=1
export EDITOR='vim'
export FZF_COMPLETION_OPTS=
export FZF_COMPLETION_TRIGGER='**'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_DEFAULT_COMMAND='rg --files --hidden'
export FZF_DEFAULT_OPTS="--color=header:#d0d0d0"
export HISTSIZE=20000
export LANG=en_US.utf-8
export LANGUAGE=en_US.utf-8:C
export LC_ALL=en_US.utf-8
export LC_CTYPE=utf-8
export LC_TIME=en_DK.UTF-8
export MANPAGER='col -b | vim -c " \
  set filetype=man tabstop=8 nomodifiable nomodeline nonumber nomagic \
  | noremap <buffer> <C-c> :qa!<CR> \
  | noremap <buffer> <Esc> :qa!<CR> \
  | noremap <buffer> q :qa!<CR> \
  " -'
export SAVEHIST=20000
export XDG_CONFIG_HOME=$HOME/.config
export XDG_DATA_HOME=$HOME/.local/share
export XDG_STATE_HOME=$HOME/.local/state
export ZGENOM_HOME=$XDG_DATA_HOME/zgenom
export ZGEN_RESET_ON_CHANGE=($HOME/.zshrc $HOME/.dotfiles/zsh/aliases.zsh)
# }}}

# Set Options {{{
setopt append_history
setopt auto_cd
setopt auto_pushd
setopt hist_expire_dups_first
setopt hist_fcntl_lock
setopt hist_ignore_all_dups
setopt hist_lex_words
setopt hist_reduce_blanks
setopt hist_save_no_dups
setopt interactivecomments
setopt no_case_glob
setopt prompt_subst # Make sure prompt is able to be generated properly.
setopt pushd_ignore_dups
setopt pushd_silent
setopt rm_star_wait
setopt share_history
# }}}
unset GREP_OPTIONS
bindkey -e

if [[ ! -d $ZGENOM_HOME ]]; then
  git clone https://github.com/jandamm/zgenom.git $ZGENOM_HOME
fi

zstyle ':completion:*:*:task:*' format '[%d]'
zstyle ':fzf-tab:*' switch-group 'ctrl-h' 'ctrl-l'
zstyle ':fzf-tab:*' use-fzf-default-opts yes
zstyle ':fzf-tab:*:*:task:*' colors ''

source "$ZGENOM_HOME/zgenom.zsh"
source "$HOME/.dotfiles/zsh/aliases.zsh"

zgenom autoupdate
if ! zgenom saved; then
  zgenom load jandamm/zgenom-ext-eval
  zgenom eval --name starship "$(starship init zsh)"

  zgenom eval --name fzf-config <<-ZSH # {{{
    $(fzf --zsh)
    bindkey '^P' fzf-history-widget
    bindkey '^N' fzf-history-widget
    bindkey -r '^G'
ZSH
# }}}
  zgenom load Aloxaf/fzf-tab
  zgenom eval --name mise "$(mise hook-env -s zsh)"
  zgenom eval --name jira_config <<ZSH # {{{
    export JIRA_HOST="https://fugamusic.atlassian.net"
    export JIRA_EMAIL="steven.weller@fuga.com"
    export JIRA_API_TOKEN=$(security find-generic-password -a "$USER" -s "JiraAPItoken" -w)
ZSH
# }}}
  zgenom load zsh-users/zsh-completions
  echo "ZGenom update, or it's plugins changed."
  echo "- Note that it does not remove the directory of unused/deprecated plugins"
  echo "- Have a look at the load time:"
  echo "    repeat 5 time zsh --interactive -c exit"
  echo "- In case of slowness, inspect what happened:"
  echo "    ZPROF=true zsh --interactive -c exit"
  zgenom compile "$HOME/.zshrc"
  zgenom  save
fi

# Unset local functions
unset -f add_to_path_once

if [[ $ZPROF != "" ]]; then
 zprof | less
fi
