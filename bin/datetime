#!/usr/bin/env bash

set -euo pipefail

# Function: first key <= target
# Arguments:
#   $1 = target number
#   $2 = name of keys array
#   $3 = name of values array
# Returns:
#   echoes the matching value
first_le() {
  local target=$1
  local -n keys=$2
  local -n values=$3
  for i in "${!keys[@]}"; do
    if (( keys[i] <= target )); then
      echo "${values[i]}"
      return
    fi
  done
}

main() {
  local result
  while getopts ":s:qm:d:h:w:" option; do
    case $option in
      s)
        result+=$(date +$OPTARG)
        ;;

      q)
        local t=$((10#$(printf '%(%M)T\n' -1)))
        local k=(45 30 15 0)
        local v=(◴ ◵ ◶ ◷)
        result+=$(first_le t k v)
        ;;

      h)
        local t=$((10#$(printf '%(%H)T\n' -1)))    # 00..23
        case $OPTARG in
          i)
            local v=(󱑖 󱑋 󱑌 󱑍 󱑎 󱑏 󱑐 󱑅 󱑆 󱑇 󱑈 󱑉 󱑊 󱐿 󱑀 󱑁 󱑂 󱑃 󱑄 󱑑 󱑒 󱑓 󱑔 󱑕)
            ;;
          k)
            local v=(㍘ ㍙ ㍚ ㍛ ㍜ ㍝ ㍞ ㍟ ㍠ ㍡ ㍢ ㍣ ㍤ ㍥ ㍦ ㍧ ㍨ ㍩ ㍪ ㍫ ㍬ ㍭ ㍮ ㍯ ㍰)
        esac
        result+="${v[t]}"
        ;;

      m)
        local t=$((10#$(printf '%(%m)T\n' -1)))
        case $OPTARG in
          i)
            result+=$t
            ;;
          k)
            local v=(0 ㋀ ㋁ ㋂ ㋃ ㋄ ㋅ ㋆ ㋇ ㋈ ㋉ ㋊ ㋋)
            result+="${v[t]}"
            ;;
        esac
        ;;

      d)
        local t=$((10#$(printf '%(%d)T\n' -1)))
        case $OPTARG in
          i)
            result+=$t
            ;;
          k)
            local v=(0 ㏠ ㏡ ㏢ ㏣ ㏤ ㏥ ㏦ ㏧ ㏨ ㏩ ㏪ ㏫ ㏬ ㏭ ㏮ ㏯ ㏰ ㏱ ㏲ ㏳ ㏴ ㏵ ㏶ ㏷ ㏸ ㏹ ㏺ ㏻ ㏼ ㏽ ㏾)
            result+="${v[t]}"
            ;;
        esac
        ;;

      w)
        local t=$(( $(printf '%(%w)T\n' -1) ))
        case $OPTARG in
          k)
            local v=(㊐ ㊊ ㊋ ㊌ ㊍ ㊎ ㊏)
            ;;
          a)
            local v=(♌ ♋ ♈ ♊ ♐ ♉ ♑)
            ;;
        esac
        result+="${v[t]}"
        ;;

      *)
        echo "not an option $option"
        exit 1
    esac
  done
  echo $result
}

main "$@"

