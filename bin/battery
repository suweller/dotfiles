#!/usr/bin/env bash

set -euo pipefail

battery_percent() {
    case $(uname -s) in
    Linux)
        percent=$(linux_acpi percent)
        [ -n "$percent" ] && echo " $percent"
        ;;
    Darwin) pmset -g batt | grep -Eo '[0-9]?[0-9]?[0-9]%' | sed 's/%//g' ;;
    FreeBSD) apm | sed '8,11d' | grep life | awk '{print $4}' ;;
    esac
}

battery_status() {
    case $(uname -s) in
    Linux) status=$(linux_acpi status) ;;
    Darwin) status=$(pmset -g batt | sed -n 2p | cut -d ';' -f 2 | tr -d " ") ;;
    FreeBSD) status=$(apm | sed '8,11d' | grep Status | awk '{printf $3}') ;;
    esac
    case $status in
    discharging | Discharging | high) echo false;;
    ACattached | charging | Charging) echo true;;
    esac
}

main() {
    bat_stat=$(battery_status)
    t="$(battery_percent)"

    local result=""
    while getopts ":sbfi" option; do
      case $option in
        s)
          result+="$t"
          ;;

        b)
          local v=(▁ ▂ ▃ ▄ ▅ ▆ ▇ █)
          local n="${#v[@]}"
          local i=$(( t * n / 101 ))
          result+="${v[i]}"
          ;;

        f)
          local v=(⅛ ⅙ ⅕ ⅓ ⅜ ⅖ ⅗ ⅝ ⅔ ⅘ ⅚ ⅞ 1)
          local n="${#v[@]}"
          local i=$(( t * n / 101 ))
          result+="${v[i]}"
          ;;

        i)
          if $bat_stat; then
            # local v=(󰢟 󰢜 󰂆 󰂇 󰂈 󰢝 󰂉 󰢞 󰂊 󰂋 󰂅)
            # local n="${#v[@]}"
            # local i=$(( t * n / 101 ))
            # # 󱉞
            # result+="${v[i]}"
            result+='󰂄'
          else
            # 󱉞
            local v=(󰂎 󰁺 󰁻 󰁼 󰁽 󰁾 󰁿 󰂀 󰂁 󰂂 󰁹)
            local n="${#v[@]}"
            local i=$(( t * n / 101 ))
            result+="${v[i]}"
          fi
          ;;

        \?) # Invalid option
          echo "Error: Invalid option"
          exit;;
      esac
    done
    echo "$result"
  }

main "$@"
